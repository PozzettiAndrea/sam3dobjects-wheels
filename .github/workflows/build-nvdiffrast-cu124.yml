name: Build nvdiffrast CUDA 12.4 + PyTorch 2.4

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

env:
  CUDA_VERSION: '12.4'
  CUDA_SHORT: '124'
  PYTORCH_VERSION: '2.4.1'
  TORCH_CUDA_ARCH_LIST: '7.5;8.6;8.9;9.0'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python: ['3.10']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install CUDA toolkit
        run: |
          # Install minimal CUDA 12.4 components from NVIDIA repos
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y cuda-nvcc-12-4 cuda-cudart-dev-12-4
          echo "/usr/local/cuda-12.4/bin" >> $GITHUB_PATH
          echo "CUDA_HOME=/usr/local/cuda-12.4" >> $GITHUB_ENV
          echo "CUDA_PATH=/usr/local/cuda-12.4" >> $GITHUB_ENV

      - name: Install OpenGL dependencies
        run: |
          sudo apt-get install -y libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev

      - name: Install CPU PyTorch and build tools
        run: |
          pip install --no-cache-dir torch==${{ env.PYTORCH_VERSION }} --index-url https://download.pytorch.org/whl/cpu
          pip install --no-cache-dir wheel setuptools ninja numpy

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}')"
          echo "CUDA_HOME=$CUDA_HOME"

      - name: Clone and build nvdiffrast
        env:
          FORCE_CUDA: "1"
          CUDA_HOME: /usr/local/cuda-12.4
          CUDA_PATH: /usr/local/cuda-12.4
          TORCH_CUDA_ARCH_LIST: ${{ env.TORCH_CUDA_ARCH_LIST }}
        run: |
          git clone https://github.com/NVlabs/nvdiffrast.git
          cd nvdiffrast
          pip install --no-build-isolation .
          python setup.py bdist_wheel
          ls -la dist/

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: nvdiffrast-linux-cu124-torch241-py${{ matrix.python }}
          path: nvdiffrast/dist/*.whl
          retention-days: 90

  build-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        python: ['3.10']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Download CUDA network installer
        shell: powershell
        run: |
          $installerUrl = "https://developer.download.nvidia.com/compute/cuda/12.4.1/network_installers/cuda_12.4.1_windows_network.exe"
          Write-Host "Downloading CUDA 12.4 network installer..."
          Invoke-WebRequest -Uri $installerUrl -OutFile "cuda_installer.exe" -UseBasicParsing

      - name: Install CUDA toolkit
        shell: powershell
        run: |
          Write-Host "Installing CUDA toolkit..."
          Start-Process -FilePath "cuda_installer.exe" -ArgumentList "-s", "-n", "nvcc_12.4", "cudart_12.4" -Wait -NoNewWindow
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
          if (Test-Path "$cudaPath\bin\nvcc.exe") {
            Write-Host "CUDA installed successfully"
          } else {
            Write-Host "WARNING: nvcc.exe not found"
            Get-ChildItem "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\" -ErrorAction SilentlyContinue
          }
          echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "CUDA_HOME=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install CPU PyTorch and build tools
        shell: bash
        run: |
          pip install torch==${{ env.PYTORCH_VERSION }} --index-url https://download.pytorch.org/whl/cpu
          pip install wheel setuptools ninja numpy

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}')"
          echo "CUDA_HOME=%CUDA_HOME%"

      - name: Clone nvdiffrast
        run: git clone https://github.com/NVlabs/nvdiffrast.git

      - name: Build wheel
        shell: cmd
        run: |
          cd nvdiffrast
          set "CUDA_HOME=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
          set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
          set FORCE_CUDA=1
          set TORCH_CUDA_ARCH_LIST=7.5;8.6;8.9;9.0
          pip install --no-build-isolation .
          python setup.py bdist_wheel
          dir dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: nvdiffrast-windows-cu124-torch241-py${{ matrix.python }}
          path: nvdiffrast/dist/*.whl
          retention-days: 90

  commit-wheels:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-wheels
          pattern: nvdiffrast-*
          merge-multiple: true

      - name: Rename wheels with CUDA version and organize
        run: |
          mkdir -p wheels/nvdiffrast
          for whl in downloaded-wheels/*.whl; do
            if [ -f "$whl" ]; then
              # nvdiffrast-0.3.3-cp310-... â†’ nvdiffrast-0.3.3+cu124-cp310-...
              basename=$(basename "$whl")
              newname=$(echo "$basename" | sed "s/-cp/+cu${{ env.CUDA_SHORT }}-cp/")
              echo "Renaming: $basename -> $newname"
              cp "$whl" "wheels/nvdiffrast/$newname"
            fi
          done
          echo "Wheels in wheels/nvdiffrast/:"
          ls -la wheels/nvdiffrast/

      - name: Generate PEP 503 index.html
        run: |
          cd wheels/nvdiffrast
          # Create new index from all wheels in directory
          echo '<!DOCTYPE html><html><body>' > index.html.new
          for whl in *.whl; do
            if [ -f "$whl" ]; then
              sha256=$(sha256sum "$whl" | cut -d' ' -f1)
              echo "<a href=\"$whl#sha256=$sha256\">$whl</a><br>" >> index.html.new
            fi
          done
          echo '</body></html>' >> index.html.new
          mv index.html.new index.html
          echo "Generated index.html:"
          cat index.html

      - name: Commit and push wheels
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wheels/
          git commit -m "Update nvdiffrast wheels (CUDA ${{ env.CUDA_VERSION }})" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push
